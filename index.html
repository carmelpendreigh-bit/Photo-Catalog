<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#667eea">
  <meta name="description" content="Capture, organize, and export your photos with metadata">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Photo Catalog">
  <title>Photo Catalog</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 20px;
    }
    
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      touch-action: manipulation;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5568d3;
    }
    
    .btn-secondary {
      background: #48bb78;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #38a169;
    }
    
    .btn-danger {
      background: #f56565;
      color: white;
    }
    
    .btn-gray {
      background: #718096;
      color: white;
    }
    
    .btn-export {
      background: #9f7aea;
      color: white;
      width: 100%;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .button-group button {
      flex: 1;
    }
    
    input[type="text"],
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 15px;
    }
    
    input[type="text"]:focus,
    textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }
    
    video, img {
      width: 100%;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    .video-container {
      position: relative;
      overflow: hidden;
      border-radius: 8px;
      margin-bottom: 15px;
      touch-action: none;
      background: black;
    }
    
    .video-container video {
      width: 100%;
      height: auto;
      display: block;
      margin: 0;
      transform-origin: center center;
    }
    
    .zoom-controls {
      position: absolute;
      bottom: 70px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 100;
    }
    
    .zoom-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid #667eea;
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .photo-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .photo-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      margin: 0;
    }
    
    .photo-info {
      padding: 15px;
    }
    
    .photo-title {
      font-size: 18px;
      font-weight: 700;
      color: #333;
      margin-bottom: 10px;
    }
    
    .photo-detail {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .photo-detail strong {
      color: #333;
    }
    
    .photo-date {
      font-size: 12px;
      color: #999;
      margin-bottom: 10px;
    }
    
    .photo-actions {
      display: flex;
      gap: 10px;
    }
    
    .photo-actions button {
      flex: 1;
      padding: 8px;
      font-size: 14px;
    }
    
    .hidden {
      display: none;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
    
    .empty-state svg {
      width: 80px;
      height: 80px;
      margin-bottom: 20px;
      opacity: 0.3;
    }
    
    .install-prompt {
      background: #fef3c7;
      border: 2px solid #fbbf24;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .install-prompt button {
      background: #f59e0b;
      color: white;
      padding: 8px 16px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="installPrompt" class="install-prompt hidden">
      <div>
        <strong>üì± Install App</strong>
        <p style="margin-top: 5px; font-size: 14px;">Add to your home screen for easy access</p>
      </div>
      <button onclick="installApp()">Install</button>
    </div>
    
    <div class="card">
      <h1>üì∏ Photo Catalog</h1>
      <p class="subtitle">Capture, organize, and export your photos</p>
      
      <div id="cameraButtons" class="button-group">
        <button class="btn-primary" onclick="startCamera()">üì∑ Take Photo</button>
        <button class="btn-primary" onclick="document.getElementById('fileInput').click()">üñºÔ∏è Upload Photo</button>
      </div>
      <input type="file" id="fileInput" accept="image/*" capture="environment" class="hidden" onchange="handleFileSelect(event)">
      
      <div id="cameraView" class="hidden">
        <div class="video-container" id="videoContainer">
          <video id="video" autoplay playsinline></video>
          <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomIn()" type="button">+</button>
            <button class="zoom-btn" onclick="zoomOut()" type="button">‚àí</button>
          </div>
        </div>
        <div class="button-group">
          <button class="btn-secondary" onclick="capturePhoto()">Capture</button>
          <button class="btn-gray" onclick="stopCamera()">Cancel</button>
        </div>
      </div>
      
      <div id="photoForm" class="hidden">
        <img id="preview" src="" alt="Preview">
        
        <label>Label (Filename) *</label>
        <input type="text" id="label" placeholder="Enter photo label">
        
        <label>Site ID</label>
        <input type="text" id="siteId" placeholder="Enter site ID">
        
        <label>Description</label>
        <input type="text" id="description" placeholder="Enter description">
        
        <label>Location</label>
        <input type="text" id="location" placeholder="Enter location">
        
        <label>Notes</label>
        <textarea id="notes" rows="3" placeholder="Enter notes"></textarea>
        
        <div class="button-group">
          <button class="btn-secondary" onclick="savePhoto()">üíæ Save Photo</button>
          <button class="btn-gray" onclick="cancelPhoto()">Cancel</button>
        </div>
      </div>
      
      <div id="editForm" class="hidden" style="background: #fef3c7; padding: 20px; border-radius: 8px; border: 2px solid #fbbf24;">
        <h3 style="margin-bottom: 15px;">Edit Photo Details</h3>
        
        <label>Label (Filename) *</label>
        <input type="text" id="editLabel" placeholder="Enter photo label">
        
        <label>Site ID</label>
        <input type="text" id="editSiteId" placeholder="Enter site ID">
        
        <label>Description</label>
        <input type="text" id="editDescription" placeholder="Enter description">
        
        <label>Location</label>
        <input type="text" id="editLocation" placeholder="Enter location">
        
        <label>Notes</label>
        <textarea id="editNotes" rows="3" placeholder="Enter notes"></textarea>
        
        <div class="button-group">
          <button class="btn-primary" onclick="updatePhoto()">üíæ Save Changes</button>
          <button class="btn-gray" onclick="cancelEdit()">Cancel</button>
        </div>
      </div>
      
      <button id="exportBtn" class="btn-export hidden" onclick="exportData()">‚¨áÔ∏è Export All</button>
    </div>
    
    <div id="gallery"></div>
  </div>
  
  <canvas id="canvas" class="hidden"></canvas>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    let photos = [];
    let currentPhoto = null;
    let currentPhotoHighRes = null;
    let stream = null;
    let editingId = null;
    let deferredPrompt;
    let currentZoom = 1;
    let videoTrack = null;
    
    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then(() => {
        console.log('Service Worker registered');
      });
    }
    
    // Install prompt
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installPrompt').classList.remove('hidden');
    });
    
    function installApp() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            document.getElementById('installPrompt').classList.add('hidden');
          }
          deferredPrompt = null;
        });
      }
    }
    
    // Load photos from localStorage
    window.addEventListener('load', () => {
      const saved = localStorage.getItem('photoCatalog');
      if (saved) {
        photos = JSON.parse(saved);
        renderGallery();
      }
    });
    
    function saveToStorage() {
      localStorage.setItem('photoCatalog', JSON.stringify(photos));
    }
    
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'environment',
            width: { ideal: 4096 },
            height: { ideal: 2160 },
            zoom: true 
          },
          audio: false 
        });
        
        const video = document.getElementById('video');
        video.srcObject = stream;
        
        // Get the video track for zoom control
        videoTrack = stream.getVideoTracks()[0];
        const capabilities = videoTrack.getCapabilities();
        
        // Reset zoom
        currentZoom = 1;
        if (capabilities.zoom) {
          await videoTrack.applyConstraints({
            advanced: [{ zoom: currentZoom }]
          });
        }
        
        // Add pinch-to-zoom
        setupPinchZoom();
        
        document.getElementById('cameraButtons').classList.add('hidden');
        document.getElementById('cameraView').classList.remove('hidden');
      } catch (err) {
        alert('Unable to access camera. Please use the "Upload Photo" button instead, which will let you take photos with your camera app.');
      }
    }
    
    function setupPinchZoom() {
      const videoContainer = document.getElementById('videoContainer');
      let initialDistance = 0;
      let initialZoom = 1;
      
      videoContainer.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          initialDistance = getDistance(e.touches[0], e.touches[1]);
          initialZoom = currentZoom;
        }
      });
      
      videoContainer.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
          e.preventDefault();
          const currentDistance = getDistance(e.touches[0], e.touches[1]);
          const scale = currentDistance / initialDistance;
          const newZoom = Math.min(Math.max(initialZoom * scale, 1), 5);
          applyZoom(newZoom);
        }
      });
    }
    
    function getDistance(touch1, touch2) {
      const dx = touch1.clientX - touch2.clientX;
      const dy = touch1.clientY - touch2.clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }
    
    async function applyZoom(zoom) {
      currentZoom = zoom;
      const video = document.getElementById('video');
      
      if (videoTrack) {
        const capabilities = videoTrack.getCapabilities();
        if (capabilities.zoom) {
          try {
            await videoTrack.applyConstraints({
              advanced: [{ zoom: currentZoom }]
            });
          } catch (err) {
            // Fallback to CSS zoom if device doesn't support camera zoom
            video.style.transform = `scale(${currentZoom})`;
          }
        } else {
          // Use CSS zoom as fallback
          video.style.transform = `scale(${currentZoom})`;
        }
      }
    }
    
    function zoomIn() {
      const newZoom = Math.min(currentZoom + 0.5, 5);
      applyZoom(newZoom);
    }
    
    function zoomOut() {
      const newZoom = Math.max(currentZoom - 0.5, 1);
      applyZoom(newZoom);
    }
    
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      currentZoom = 1;
      videoTrack = null;
      const video = document.getElementById('video');
      video.style.transform = 'scale(1)';
      document.getElementById('cameraView').classList.add('hidden');
      document.getElementById('cameraButtons').classList.remove('hidden');
    }
    
    function capturePhoto() {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      
      // High-quality version for download to gallery
      const highResPhoto = canvas.toDataURL('image/jpeg', 1.0);
      
      // Compressed version for app storage (smaller file size)
      const compressedPhoto = canvas.toDataURL('image/jpeg', 0.6);
      
      currentPhoto = compressedPhoto;
      currentPhotoHighRes = highResPhoto;
      
      stopCamera();
      showPhotoForm();
    }
    
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          currentPhoto = e.target.result;
          showPhotoForm();
        };
        reader.readAsDataURL(file);
      }
    }
    
    function showPhotoForm() {
      document.getElementById('preview').src = currentPhoto;
      document.getElementById('cameraButtons').classList.add('hidden');
      document.getElementById('photoForm').classList.remove('hidden');
    }
    
    function generateUniqueFilename(label, dateTaken) {
      const date = new Date(dateTaken);
      const dateStr = date.getFullYear() + 
                      String(date.getMonth() + 1).padStart(2, '0') + 
                      String(date.getDate()).padStart(2, '0');
      
      // Find existing photos with same label and date
      const sameLabelPhotos = photos.filter(p => {
        const pDate = new Date(p.dateTaken || p.timestamp);
        const pDateStr = pDate.getFullYear() + 
                        String(pDate.getMonth() + 1).padStart(2, '0') + 
                        String(pDate.getDate()).padStart(2, '0');
        return p.label === label && pDateStr === dateStr;
      });
      
      // Get next sequential number
      const nextNum = sameLabelPhotos.length + 1;
      const numStr = String(nextNum).padStart(3, '0');
      
      return `${label}_${dateStr}_${numStr}`;
    }
    
    function savePhoto() {
      const label = document.getElementById('label').value.trim();
      
      if (!label) {
        alert('Please add a label (filename) for the photo');
        return;
      }
      
      const now = new Date();
      const filename = generateUniqueFilename(label, now.toISOString());
      
      // Store compressed version in app (small file for gallery display)
      const photo = {
        id: Date.now(),
        imageData: currentPhoto, // Compressed 60% quality
        label: label,
        filename: filename,
        siteId: document.getElementById('siteId').value,
        description: document.getElementById('description').value,
        location: document.getElementById('location').value,
        notes: document.getElementById('notes').value,
        timestamp: now.toISOString(),
        dateTaken: now.toISOString()
      };
      
      photos.push(photo);
      saveToStorage();
      
      // Download HIGH-RES version to phone's gallery
      const link = document.createElement('a');
      link.href = currentPhotoHighRes || currentPhoto;
      link.download = `${filename}.jpg`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Clear form and show gallery
      currentPhoto = null;
      currentPhotoHighRes = null;
      document.getElementById('photoForm').classList.add('hidden');
      document.getElementById('cameraButtons').classList.remove('hidden');
      document.getElementById('label').value = '';
      document.getElementById('siteId').value = '';
      document.getElementById('description').value = '';
      document.getElementById('location').value = '';
      document.getElementById('notes').value = '';
      document.getElementById('fileInput').value = '';
      
      renderGallery();
      
      // Scroll to gallery to see the saved photo
      setTimeout(() => {
        const gallery = document.getElementById('gallery');
        if (gallery) {
          gallery.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 100);
    }
    
    function cancelPhoto() {
      currentPhoto = null;
      document.getElementById('photoForm').classList.add('hidden');
      document.getElementById('cameraButtons').classList.remove('hidden');
      
      // Reset form
      document.getElementById('label').value = '';
      document.getElementById('siteId').value = '';
      document.getElementById('description').value = '';
      document.getElementById('location').value = '';
      document.getElementById('notes').value = '';
      document.getElementById('fileInput').value = '';
    }
    
    function editPhoto(id) {
      const photo = photos.find(p => p.id === id);
      if (!photo) return;
      
      editingId = id;
      document.getElementById('editLabel').value = photo.label;
      document.getElementById('editSiteId').value = photo.siteId || '';
      document.getElementById('editDescription').value = photo.description || '';
      document.getElementById('editLocation').value = photo.location || '';
      document.getElementById('editNotes').value = photo.notes || '';
      
      document.getElementById('editForm').classList.remove('hidden');
      document.getElementById('cameraButtons').classList.add('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function updatePhoto() {
      const label = document.getElementById('editLabel').value.trim();
      
      if (!label) {
        alert('Please add a label (filename) for the photo');
        return;
      }
      
      photos = photos.map(photo => {
        if (photo.id === editingId) {
          return {
            ...photo,
            label: label,
            siteId: document.getElementById('editSiteId').value,
            description: document.getElementById('editDescription').value,
            location: document.getElementById('editLocation').value,
            notes: document.getElementById('editNotes').value
          };
        }
        return photo;
      });
      
      saveToStorage();
      renderGallery();
      cancelEdit();
    }
    
    function cancelEdit() {
      editingId = null;
      document.getElementById('editForm').classList.add('hidden');
      document.getElementById('cameraButtons').classList.remove('hidden');
    }
    
    function deletePhoto(id) {
      if (confirm('Delete this photo?')) {
        photos = photos.filter(p => p.id !== id);
        saveToStorage();
        renderGallery();
      }
    }
    
    function renderGallery() {
      const gallery = document.getElementById('gallery');
      const exportBtn = document.getElementById('exportBtn');
      
      if (photos.length === 0) {
        gallery.innerHTML = `
          <div class="card empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path>
              <circle cx="12" cy="13" r="3"></circle>
            </svg>
            <h3>No Photos Yet</h3>
            <p>Start by taking or uploading your first photo</p>
          </div>
        `;
        exportBtn.classList.add('hidden');
        return;
      }
      
      const selectedCount = photos.filter(p => p.selected).length;
      exportBtn.classList.remove('hidden');
      exportBtn.innerHTML = selectedCount > 0 
        ? `‚¨áÔ∏è Export Selected (${selectedCount} records)`
        : `‚¨áÔ∏è Export All (${photos.length} records)`;
      
      gallery.innerHTML = `
        <div class="card">
          <h2>Your Photo Records (${photos.length})</h2>
          <p style="color: #666; margin-top: 10px; font-size: 14px;">Photos are saved in your gallery. This shows metadata only.</p>
          <div style="margin-top: 10px;">
            <button class="btn-primary" onclick="selectAll()" style="margin-right: 10px;">‚úì Select All</button>
            <button class="btn-gray" onclick="deselectAll()">‚úó Deselect All</button>
          </div>
        </div>
        <div class="photo-grid">
          ${photos.map(photo => `
            <div class="photo-card" style="min-height: 200px;">
              <div style="padding: 15px;">
                <input type="checkbox" 
                  ${photo.selected ? 'checked' : ''} 
                  onchange="togglePhoto(${photo.id})"
                  style="width: 24px; height: 24px; cursor: pointer; margin-bottom: 10px;">
                <div class="photo-title">${photo.filename || photo.label}</div>
                ${photo.siteId ? `<div class="photo-detail"><strong>Site ID:</strong> ${photo.siteId}</div>` : ''}
                ${photo.description ? `<div class="photo-detail"><strong>Description:</strong> ${photo.description}</div>` : ''}
                ${photo.location ? `<div class="photo-detail"><strong>Location:</strong> ${photo.location}</div>` : ''}
                ${photo.notes ? `<div class="photo-detail"><strong>Notes:</strong> ${photo.notes}</div>` : ''}
                <div class="photo-detail"><strong>Date Taken:</strong> ${new Date(photo.dateTaken || photo.timestamp).toLocaleDateString()} ${new Date(photo.dateTaken || photo.timestamp).toLocaleTimeString()}</div>
                <div class="photo-date" style="margin-top: 10px;">Added: ${new Date(photo.timestamp).toLocaleString()}</div>
                <div class="photo-actions" style="margin-top: 15px;">
                  <button class="btn-primary" onclick="editPhoto(${photo.id})">‚úèÔ∏è Edit</button>
                  <button class="btn-danger" onclick="deletePhoto(${photo.id})">üóëÔ∏è Delete</button>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    function togglePhoto(id) {
      photos = photos.map(photo => {
        if (photo.id === id) {
          return { ...photo, selected: !photo.selected };
        }
        return photo;
      });
      saveToStorage();
      renderGallery();
    }
    
    function selectAll() {
      photos = photos.map(photo => ({ ...photo, selected: true }));
      saveToStorage();
      renderGallery();
    }
    
    function deselectAll() {
      photos = photos.map(photo => ({ ...photo, selected: false }));
      saveToStorage();
      renderGallery();
    }
    
    async function exportData() {
      if (photos.length === 0) {
        alert('No photo records to export');
        return;
      }
      
      // Get photos to export (selected ones, or all if none selected)
      const photosToExport = photos.filter(p => p.selected).length > 0 
        ? photos.filter(p => p.selected)
        : photos;
      
      if (photosToExport.length === 0) {
        alert('No records selected for export');
        return;
      }
      
      // Create CSV with Date_Taken column
      const csvHeaders = 'Filename,Label,Site_ID,Description,Location,Notes,Date_Taken,Timestamp\n';
      const csvRows = photosToExport.map(photo => {
        const escape = (str) => `"${(str || '').replace(/"/g, '""')}"`;
        const dateTaken = photo.dateTaken || photo.timestamp;
        const filename = photo.filename || photo.label;
        return [
          escape(filename),
          escape(photo.label),
          escape(photo.siteId || ''),
          escape(photo.description || ''),
          escape(photo.location || ''),
          escape(photo.notes || ''),
          escape(dateTaken),
          escape(photo.timestamp)
        ].join(',');
      }).join('\n');
      const csvContent = csvHeaders + csvRows;
      
      // Download CSV file
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `photo_catalog_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      alert(`Exported ${photosToExport.length} records to CSV. Photos are already in your gallery!`);
    }
  </script>
</body>
</html>
